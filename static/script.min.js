let youtubeId,youlagScriptLoaded=!1,youtubeExtensionInstalled=!1,modePip=!1,modeFullscreen=!0;const modalContainerClassName="youlag-theater-modal-container",modalContentClassName="youlag-theater-modal-content",modalCloseIdName="youlagCloseModal",modalMinimizeIdName="youlagMinimizeModal",modalVideoSourceIdName="youlagVideoSource",modalVideoSourceDefaultIdName="youlagVideoSourceDefault",modalToggleFavoriteIdName="youlagToggleFavorite",modalFavoriteClassName="youlag-favorited";function youlagSettingsPageEventListeners(){let e=document.getElementById("youlag_check_updates");e&&e.addEventListener("click",()=>{window.open("https://github.com/civilblur/youlag/releases")});const t=document.getElementById("youlag_playback_invidious"),o=document.getElementById("youlag_playback_youtube"),a=document.getElementById("yl_invidious_url_1");if(t&&o&&a){function n(){t.checked?a.setAttribute("required","required"):a.removeAttribute("required")}t.addEventListener("change",n),o.addEventListener("change",n),n()}}function handleActiveRssItem(e){let t;if(t=e instanceof Event?e.target.closest("div[data-feed]"):e.closest("div[data-feed]"),!t)return;const o=extractFeedItemData(t);o.feedItemEl=t,createModalWithData(o),modePip||setModeFullscreen(!0)}function getVideoIdFromUrl(e){const t=e.match(/(?:\/|^)(?:shorts\/|v\/|e(?:mbed)?\/|\S*?[?&]v=|\S*?[?&]id=|v=)([a-zA-Z0-9_-]{11})(?:[\/\?]|$)/);return t?t[1]:""}function getBaseUrl(e){try{const t=new URL(e);return`${t.protocol}//${t.host}`}catch(e){return console.error("Invalid URL:",e),""}}function matchURL(e){if(!e||"string"!=typeof e)return[];const t=e.match(/https?:\/\/[\w\-._~:/?#\[\]@!$&'()*+,;=%]+[\w\-_/~#@?=&%]/g);return t||[]}function appendUrl(e){console.log("appendUrl input:",e);const t=matchURL(e);return t&&t.forEach(t=>{const o=document.createElement("a");o.href=t,o.textContent=t,o.target="_blank",e=e.replace(t,o.outerHTML)}),e}function sanitizeExtractedVideoUrl(e){const t=String(e);if(/^https?:\/\//.test(t.trim()))return t.trim();const o=t.match(/href=["']([^"'>]+)["']/);return o&&o[1]?o[1]:""}function extractFeedItemData(e){let t=e.querySelector('.item.titleAuthorSummaryDate a[href*="youtube"], .item.titleAuthorSummaryDate a[href*="/watch?v="]')?.href||"";t||(t=e.querySelector('.enclosure-content a[href*="youtube"], .enclosure-content a[href*="/watch?v="]'),t=sanitizeExtractedVideoUrl(t),youtubeExtensionInstalled=!!t);const o=""!==t,a=null!==e.querySelector(".enclosure-description"),n=o?getBaseUrl(t):"";youtubeId=t?getVideoIdFromUrl(t):"";const i=youtubeId?`https://www.youtube.com/watch?v=${youtubeId}`:"",l=youtubeId?`https://www.youtube.com/embed/${youtubeId}`:"",d=youtubeId?`${n}/embed/${youtubeId}`:"",r=e.querySelector(".flux_header"),s=r?.querySelector('.website a.item-element[href*="get=f_"]'),c=e.querySelector(".content div.text span[data-yl-invidious-instance]")?.getAttribute("data-yl-invidious-instance"),u=e.querySelector(".content div.text span[data-yl-video-source-default]")?.getAttribute("data-yl-video-source-default");return{author:r?.getAttribute("data-article-authors")||"",author_filter_url:s?.href||"",favicon:e.querySelector("img.favicon")?.src||"",favorite_toggle_url:e.querySelector("a.item-element.bookmark")?.href||"",favorited:!e.querySelector('.bookmark img[src*="non-starred"]'),thumbnail:e.querySelector(".thumbnail img")?.src||"",title:e.querySelector(".item-element.title")?.childNodes[0].textContent.trim()||"",external_link:e.querySelector(".item-element.title")?.href||"",date:e.querySelector(".flux_content .date")?.textContent.trim()||"",youtube_embed_url:l,video_embed_url:d,video_invidious_instance_1:c||"",video_source_default:u||"youtube",video_description:`<div class="youlag-video-description-content">\n        ${o&&a?appendUrl(e.querySelector(".enclosure-description")?.innerHTML.trim()):e.querySelector("article div.text")?.innerHTML.trim()||""}\n      </div>`,video_youtube_url:i,video_invidious_redirect_url:""+(youtubeId?"https://redirect.invidious.io/watch?v="+youtubeId:"")}}function createModalWithData(e){let t=document.getElementById("youlagTheaterModal");t||(t=document.createElement("div"),t.id="youlagTheaterModal",t.innerHTML=`<div class="${modalContainerClassName}"></div>`,document.body.appendChild(t));const o=t.querySelector(`.${modalContainerClassName}`),a=e.video_source_default,n="youtube"===a?"selected":"",i="invidious_1"===a?"selected":"",l=e.video_invidious_instance_1;function d(t){return"invidious_1"===t&&e.video_invidious_instance_1?`${e.video_invidious_instance_1.replace(/\/$/,"")}/embed/${youtubeId}`:"youtube"===t?e.youtube_embed_url:""}const r=d("invidious_1"===a?"invidious_1":"youtube");o.innerHTML=`\n    <div class="${modalContentClassName}">\n\n      <div class="youlag-video-header">\n        <select id="youlagVideoSource" class="${l?"":"display-none"}">\n          <option value="youtube" ${n}>YouTube</option>\n          <option value="invidious_1" ${i}>Invidious</option>\n        </select>\n\n        <button id="${modalMinimizeIdName}">‚ßâ</button>\n        <button id="${modalCloseIdName}">√ó</button>\n      </div>\n\n      <div class="youlag-video-container">\n        <div class="youlag-thumbnail-container">\n          <img src="${e.thumbnail}" class="youlag-video-thumbnail" />\n        </div>\n        <div class="youlag-iframe-container">\n          <iframe class="youlag-iframe"\n                  src="${r}" frameborder="0" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>\n        </div>\n      </div>\n\n\n      <div class="youlag-video-details">\n\n        <div class="youlag-video-metadata-container">\n          <h2 class="youlag-video-metadata-title">${e.title}</h2>\n          <div class="youlag-video-metadata-panel">\n\n            <section class="youlag-video-author-section">\n              <a class="youlag-video-metadata-favicon-link" href="${e.author_filter_url}">\n                <img src="${e.favicon}" class="youlag-video-metadata-favicon" />\n              </a>\n\n              <div class="yl-flex yl-flex-col">\n                <div class="youlag-video-metadata-author">\n                  <a href="${e.author_filter_url}">${e.author}</a>\n                </div>\n                <div class="youlag-video-metadata-date">${e.date}</div>\n              </div>\n            </section>\n\n            <section class="youlag-video-actions-container">\n              <a href="#" \n                class="yl-video-action-button youlag-favorited youlag-favorited--${e.favorited}"\n                id="youlagToggleFavorite">\n                <div class="youlag-favorited-icon"></div>\n              </a>\n              <a class="yl-video-action-button" href="${e.external_link}" target="_blank">\n                <span class="yl-video-action-button__icon">üåê</span><span>Source</span>\n              </a>\n\n\n\n              <div class="yl-video-action-button-group">\n                <a class="yl-video-action-button" href="${e.video_youtube_url}" target="_blank">\n                  <span class="yl-video-action-button__icon">‚ñ∂Ô∏è</span><span>YouTube</span>\n                </a>\n                <a class="yl-video-action-button" href="${e.video_invidious_redirect_url}" target="_blank">\n                  <span class="yl-video-action-button__icon">üì∫</span><span>Invidious</span>\n                </a>\n              </div>\n\n            </section>\n\n          </div>\n\n        </div>\n\n\n\n        <div class="youlag-video-description-container">\n          ${e.video_description}\n        </div>\n        \n      </div>\n\n    </div>\n  `;const s=o.querySelector("#youlagVideoSource"),c=o.querySelector(".youlag-iframe");if(s&&c&&s.addEventListener("change",function(){c.src=d(s.value)}),!youtubeId){t.classList.add("youlag-modal-feed-item--text"),document.querySelector(".youlag-iframe-container")&&document.querySelector(".youlag-iframe-container").remove()}o.querySelector(`#${modalCloseIdName}`)?.addEventListener("click",closeModal),o.querySelector(`#${modalMinimizeIdName}`)?.addEventListener("click",togglePipMode),o.querySelector("#youlagToggleFavorite")?.addEventListener("click",t=>{t.preventDefault(),toggleFavorite(e.favorite_toggle_url,o,e.feedItemEl)}),history.pushState({modalOpen:!0},"",""),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeModal()}),window.addEventListener("popstate",closeModal)}function toggleFavorite(e,t,o){const a=t.querySelector("#youlagToggleFavorite");a&&fetch(e,{method:"GET"}).then(e=>{if(e.ok){const e=a.classList.contains("youlag-favorited--true"),t=o.querySelector(".item-element.bookmark img.icon");a.classList.remove(`youlag-favorited--${e}`),a.classList.add(`youlag-favorited--${!e}`),e?(o.classList.remove("favorite"),t&&(t.src="../themes/Mapco/icons/non-starred.svg")):(o.classList.add("favorite"),t&&(t.src="../themes/Mapco/icons/starred.svg"))}else console.error("Failed to toggle favorite status")}).catch(e=>console.error("Error:",e))}function closeModal(){const e=document.getElementById("youlagTheaterModal");e&&e.remove(),history.state&&history.state.modalOpen&&history.back(),setModePip(!1),setModeFullscreen(!1)}function togglePipMode(){modePip?(setModePip(!1),setModeFullscreen(!0)):(setModePip(!0),setModeFullscreen(!1))}function setModePip(e){!0===e?(document.body.classList.add("youlag-mode--pip"),modePip=!0,modeFullscreen=!1):!1===e&&(document.body.classList.remove("youlag-mode--pip"),modePip=!1)}function setModeFullscreen(e){!0===e?(document.body.classList.add("youlag-mode--fullscreen"),document.body.classList.remove("youlag-mode--pip"),modeFullscreen=!0,modePip=!1):!1===e&&(document.body.classList.remove("youlag-mode--fullscreen"),modeFullscreen=!1)}function setupClickListener(){const e=document.querySelector("#stream");e&&e.addEventListener("click",e=>{if(e.target.closest("div[data-feed] .flux_header li.manage"))return;if(e.target.closest("div[data-feed] .flux_header li.labels"))return;if(e.target.closest("div[data-feed] .flux_header li.share"))return;if(e.target.closest("div[data-feed] .flux_header li.link"))return;if(e.target.closest('div[data-feed] .flux_header .website a[href^="./?get=f_"]'))return;const t=e.target.closest("div[data-feed]");t&&(handleActiveRssItem(e),collapseBackgroundFeedItem(t))})}function collapseBackgroundFeedItem(e){const t=e;let o=t.classList.contains("active")&&t.classList.contains("current");const a=t.querySelectorAll("iframe");(a||youtubeExtensionInstalled)&&a.forEach(e=>{const t=e.getAttribute("src");t&&(e.setAttribute("data-original",t),e.setAttribute("src",""))}),o&&(t.classList.remove("active"),t.classList.remove("current"))}function init(){setupClickListener(),setTimeout(()=>{youlagSettingsPageEventListeners()},1e3),removeYoulagLoadingState(),youlagScriptLoaded=!0}function removeYoulagLoadingState(){document.body.classList.add("youlag-loaded")}function initFallback(){"complete"===document.readyState||"interactive"===document.readyState||!0===youlagScriptLoaded?init():(document.addEventListener("DOMContentLoaded",init),window.addEventListener("load",init))}const checkInitInterval=setInterval(()=>{"complete"!==document.readyState&&!0!==youlagScriptLoaded||(init(),clearInterval(checkInitInterval))},1e3);initFallback();