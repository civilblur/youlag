let youtubeId,youlagScriptLoaded=!1,youlagRestoreVideoQueueRan=!1,youlagActive=!0,youtubeExtensionInstalled=!1,previousPageTitle=null,modePip=!1,modeFullscreen=!0;const modalContainerClassName="youlag-theater-modal-container",modalContentClassName="youlag-theater-modal-content",modalCloseIdName="youlagCloseModal",modalMinimizeIdName="youlagMinimizeModal",modalVideoSourceIdName="youlagVideoSource",modalVideoSourceDefaultIdName="youlagVideoSourceDefault",modalToggleFavoriteIdName="youlagToggleFavorite",modalFavoriteClassName="youlag-favorited",modalTagsIdName="youlagTagsModal";function youlagSettingsPageEventListeners(){const e=document.getElementById("yl_playback_invidious"),t=document.getElementById("yl_playback_youtube"),o=document.getElementById("yl_invidious_url_1");if(e&&t&&o){function a(){e.checked?o.setAttribute("required","required"):o.removeAttribute("required")}e.addEventListener("change",a),t.addEventListener("change",a),a()}}function handleActiveRssItem(e,t=!1){let o;if(t){const t=e;o={...t.queue[t.activeIndex],queue:t.queue,activeIndex:t.activeIndex}}else{const t=e instanceof Event?e.target.closest("div[data-feed]"):e.closest("div[data-feed]");if(!t)return;o=extractFeedItemData(t),o.feedItemEl=t}createModalWithData(o),modePip||setModeFullscreen(!0)}function getVideoIdFromUrl(e){const t=e.match(/(?:\/|^)(?:shorts\/|v\/|e(?:mbed)?\/|\S*?[?&]v=|\S*?[?&]id=|v=)([a-zA-Z0-9_-]{11})(?:[\/\?]|$)/);return t?t[1]:""}function getBaseUrl(e){try{const t=new URL(e);return`${t.protocol}//${t.host}`}catch(e){return console.error("Invalid URL:",e),""}}function matchURL(e){if(!e||"string"!=typeof e)return[];const t=e.match(/https?:\/\/[\w\-._~:/?#\[\]@!$&'()*+,;=%]+[\w\-_/~#@?=&%]/g);return t||[]}function appendUrl(e){console.log("appendUrl input:",e);const t=matchURL(e);return t&&t.forEach(t=>{const o=document.createElement("a");o.href=t,o.textContent=t,o.target="_blank",e=e.replace(t,o.outerHTML)}),e}function sanitizeExtractedVideoUrl(e){const t=String(e);if(/^https?:\/\//.test(t.trim()))return t.trim();const o=t.match(/href=["']([^"'>]+)["']/);return o&&o[1]?o[1]:""}function extractFeedItemData(e){let t=e.querySelector('.item.titleAuthorSummaryDate a[href*="youtube"], .item.titleAuthorSummaryDate a[href*="/watch?v="]')?.href||"";t||(t=e.querySelector('.enclosure-content a[href*="youtube"], .enclosure-content a[href*="/watch?v="]'),t=sanitizeExtractedVideoUrl(t),youtubeExtensionInstalled=!!t);const o=""!==t,a=null!==e.querySelector(".enclosure-description"),n=o?getBaseUrl(t):"";youtubeId=t?getVideoIdFromUrl(t):"";const i=youtubeId?`https://www.youtube.com/watch?v=${youtubeId}`:"",l=youtubeId?`https://www.youtube.com/embed/${youtubeId}`:"",s=youtubeId?`${n}/embed/${youtubeId}`:"",r=e.querySelector(".flux_header"),c=r?.querySelector('.website a.item-element[href*="get=f_"]'),d=e.querySelector(".content div.text span[data-yl-invidious-instance]"),u=d?d.getAttribute("data-yl-invidious-instance"):"",g=e.querySelector(".content div.text span[data-yl-video-source-default]"),m=g?g.getAttribute("data-yl-video-source-default"):"",y={author:r?.getAttribute("data-article-authors")||"",author_filter_url:c?.href||"",favicon:e.querySelector("img.favicon")?.src||"",favorite_toggle_url:e.querySelector("a.item-element.bookmark")?.href||"",favorited:!e.querySelector('.bookmark img[src*="non-starred"]'),thumbnail:e.querySelector(".thumbnail img")?.src||"",title:e.querySelector(".item-element.title")?.childNodes[0].textContent.trim()||"",external_link:e.querySelector(".item-element.title")?.href||"",date:e.querySelector(".flux_content .date")?.textContent.trim()||"",isVideoFeedItem:o,youtubeId:youtubeId,youtube_embed_url:l,video_embed_url:s,video_invidious_instance_1:u||"",video_source_default:m||"youtube",video_description:`<div class="youlag-video-description-content">\n        ${o&&a?appendUrl(e.querySelector(".enclosure-description")?.innerHTML.trim()):e.querySelector("article div.text")?.innerHTML.trim()||""}\n      </div>`,video_youtube_url:i,video_invidious_redirect_url:""+(youtubeId?"https://redirect.invidious.io/watch?v="+youtubeId:"")};return setVideoQueue(y),y}function setVideoQueue(e){let t=[],o=0;try{const e=localStorage.getItem("youlagVideoQueue");if(e){const a=JSON.parse(e);Array.isArray(a.queue)&&(t=a.queue),"number"==typeof a.activeIndex&&(o=a.activeIndex)}}catch(e){}const a=e.video_youtube_url,n=t.findIndex(e=>e.video_youtube_url===a);-1===n?(t.push(e),o=t.length-1):o=n,localStorage.setItem("youlagVideoQueue",JSON.stringify({queue:t,activeIndex:o}))}function clearVideoQueue(){localStorage.removeItem("youlagVideoQueue")}function restoreVideoQueue(){if(youlagRestoreVideoQueueRan)return;youlagRestoreVideoQueueRan=!0;let e=null;try{const t=localStorage.getItem("youlagVideoQueue");t&&(e=JSON.parse(t))}catch(t){e=null}e&&Array.isArray(e.queue)&&"number"==typeof e.activeIndex&&e.queue.length>0&&(setModePip(!0),handleActiveRssItem(e,!0))}function setPageTitle(e){"string"==typeof e&&e.length>0?(null===previousPageTitle&&(previousPageTitle=document.title),document.title=e):null!==previousPageTitle&&(document.title=previousPageTitle,previousPageTitle=null)}function createModalWithData(e){let t=document.getElementById("youlagTheaterModal");t||(t=document.createElement("div"),t.id="youlagTheaterModal",t.innerHTML=`<div class="${modalContainerClassName}"></div>`,document.body.appendChild(t));const o=t.querySelector(`.${modalContainerClassName}`),a=e.video_source_default,n="youtube"===a?"selected":"",i="invidious_1"===a?"selected":"",l=e.video_invidious_instance_1;function s(t){return"invidious_1"===t&&e.video_invidious_instance_1&&e.youtubeId?`${e.video_invidious_instance_1.replace(/\/$/,"")}/embed/${e.youtubeId}`:"youtube"===t?e.youtube_embed_url:""}const r=s("invidious_1"===a?"invidious_1":"youtube");setPageTitle(e.title),o.innerHTML=`\n    <div class="${modalContentClassName}">\n\n      <div class="youlag-video-header">\n        <select id="youlagVideoSource" class="${l&&e.isVideoFeedItem?"":"display-none"}">\n          <option value="youtube" ${n}>YouTube</option>\n          <option value="invidious_1" ${i}>Invidious</option>\n        </select>\n\n        <button id="${modalMinimizeIdName}">‚ßâ</button>\n        <button id="${modalCloseIdName}">√ó</button>\n      </div>\n\n      <div class="youlag-video-container">\n        <div class="youlag-thumbnail-container">\n          <img src="${e.thumbnail}" class="youlag-video-thumbnail" />\n        </div>\n        <div class="youlag-iframe-container">\n          <iframe class="youlag-iframe"\n                  src="${r}" frameborder="0" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>\n        </div>\n      </div>\n\n\n      <div class="youlag-video-details">\n\n        <div class="youlag-video-metadata-container">\n          <h2 class="youlag-video-metadata-title">${e.title}</h2>\n          <div class="youlag-video-metadata-panel">\n\n            <section class="youlag-video-author-section">\n              <a class="youlag-video-metadata-favicon-link" href="${e.author_filter_url}">\n                <img src="${e.favicon}" class="youlag-video-metadata-favicon" />\n              </a>\n\n              <div class="yl-flex yl-flex-col">\n                <div class="youlag-video-metadata-author">\n                  <a href="${e.author_filter_url}">${e.author}</a>\n                </div>\n                <div class="youlag-video-metadata-date">${e.date}</div>\n              </div>\n            </section>\n\n            <section class="youlag-video-actions-container">\n              <a href="#" \n                class="yl-video-action-button youlag-favorited youlag-favorited--${e.favorited}"\n                id="youlagToggleFavorite">\n                <div class="youlag-favorited-icon"></div>\n              </a>\n              <a class="yl-video-action-button" href="${e.external_link}" target="_blank">\n                <span class="yl-video-action-button__icon">üåê</span><span>Source</span>\n              </a>\n\n              <a class="yl-video-action-button" href="${e.video_youtube_url}" target="_blank">\n                <span class="yl-video-action-button__icon">‚ñ∂Ô∏è</span><span>YouTube</span>\n              </a>\n              <a class="yl-video-action-button" href="${e.video_invidious_redirect_url}" target="_blank">\n                <span class="yl-video-action-button__icon">üì∫</span><span>Invidious</span>\n              </a>\n\n            </section>\n\n          </div>\n\n        </div>\n\n\n\n        <div class="youlag-video-description-container">\n          ${e.video_description}\n        </div>\n        \n      </div>\n\n    </div>\n  `;const c=o.querySelector("#youlagVideoSource"),d=o.querySelector(".youlag-iframe");if(c&&d&&c.addEventListener("change",function(){d.src=s(c.value)}),!e.youtubeId){t.classList.add("youlag-modal-feed-item--text"),document.querySelector(".youlag-iframe-container")&&document.querySelector(".youlag-iframe-container").remove()}o.querySelector(`#${modalCloseIdName}`)?.addEventListener("click",closeModal),o.querySelector(`#${modalMinimizeIdName}`)?.addEventListener("click",togglePipMode),o.querySelector("#youlagToggleFavorite")?.addEventListener("click",t=>{t.preventDefault(),toggleFavorite(e.favorite_toggle_url,o,e.feedItemEl)}),history.pushState({modalOpen:!0},"",""),document.addEventListener("keydown",e=>{"Escape"===e.key&&closeModal()}),window.addEventListener("popstate",closeModal)}function toggleFavorite(e,t,o){const a=t.querySelector("#youlagToggleFavorite");a&&fetch(e,{method:"GET"}).then(e=>{if(e.ok){const e=a.classList.contains("youlag-favorited--true");if(a.classList.remove(`youlag-favorited--${e}`),a.classList.add(`youlag-favorited--${!e}`),o){const t=o.querySelector(".item-element.bookmark img.icon");e?(o.classList.remove("favorite"),t&&(t.src="../themes/Mapco/icons/non-starred.svg")):(o.classList.add("favorite"),t&&(t.src="../themes/Mapco/icons/starred.svg"))}}else console.error("Failed to toggle favorite status")}).catch(e=>console.error("Error:",e))}function closeModal(){const e=document.getElementById("youlagTheaterModal");e&&e.remove(),history.state&&history.state.modalOpen&&history.back(),setModePip(!1),setModeFullscreen(!1),setPageTitle(),clearVideoQueue()}function togglePipMode(){modePip?(setModePip(!1),setModeFullscreen(!0)):(setModePip(!0),setModeFullscreen(!1))}function setModePip(e){!0===e?(document.body.classList.add("youlag-mode--pip"),modePip=!0,modeFullscreen=!1):!1===e&&(document.body.classList.remove("youlag-mode--pip"),modePip=!1)}function setModeFullscreen(e){!0===e?(document.body.classList.add("youlag-mode--fullscreen"),document.body.classList.remove("youlag-mode--pip"),modeFullscreen=!0,modePip=!1):!1===e&&(document.body.classList.remove("youlag-mode--fullscreen"),modeFullscreen=!1)}function setupClickListener(){if(!youlagActive)return;const e=document.querySelector("#stream");e&&e.addEventListener("click",e=>{if(e.target.closest("div[data-feed] .flux_header li.manage"))return;if(e.target.closest("div[data-feed] .flux_header li.labels"))return;if(e.target.closest("div[data-feed] .flux_header li.share"))return;if(e.target.closest("div[data-feed] .flux_header li.link"))return;if(e.target.closest('div[data-feed] .flux_header .website a[href^="./?get=f_"]'))return;const t=e.target.closest("div[data-feed]");t&&(handleActiveRssItem(e),collapseBackgroundFeedItem(t))})}function setupTagsDropdownOverride(){const e=document.querySelector("#stream");e&&e.addEventListener("click",async function(e){const t=e.target.closest("div[data-feed] .flux_header li.labels");if(t.querySelector("a.dropdown-toggle")){e.preventDefault(),e.stopImmediatePropagation();let o=t.querySelector(".dropdown-target")?.id,a=o?o.match(/([0-9]+)$/):null;o=a?a[1]:null,createTagsModal(o,await getItemTags(o))}},!0)}function createTagsModal(e,t){document.getElementById(modalTagsIdName)&&document.getElementById(modalTagsIdName).remove();let o=document.createElement("div");const a=!!document.querySelector("body.youlag-video-labels")?"Save to...":"Tags";o.id=modalTagsIdName,o.classList.add("youlag-tags-modal"),o.innerHTML=`\n    <forms class="yl-tags-content">\n      <h3 class="yl-tags-modal-title">\n        ${a}\n\n        <a href="./?c=tag" target="_blank"><img class="icon" src="../themes/Mapco/icons/configure.svg" loading="lazy" alt="‚öôÔ∏è"></a>\n      </h3>\n      <div class="yl-tags-list">\n        ${t.map(t=>`\n            <div class="yl-tags-list-item">\n              <input type="checkbox" id="yl-tag-${t.id}" data-tag-id="${t.id}" data-entry-id="${e}" ${t.checked?"checked":""} />\n              <label for="yl-tag-${t.id}">${t.name}</label>\n            </div>\n          `).join("")}\n      </div>\n      <div class="yl-tags-modal-actions">\n        <button id="yl-tags-modal-close" class="btn">Done</button>\n      </div>\n    </forms>\n  `,document.body.appendChild(o);o.querySelectorAll('.yl-tags-list-item input[type="checkbox"]').forEach(e=>{e.addEventListener("change",function(){const e=this.getAttribute("data-tag-id");setItemTag(this.getAttribute("data-entry-id"),{id:e,checked:this.checked})})});o.querySelector("#yl-tags-modal-close").addEventListener("click",function(){const e=document.getElementById(modalTagsIdName);e&&e.remove()})}async function getItemTags(e){if(!e)return[];const t=`./?c=tag&a=getTagsForEntry&id_entry=${encodeURIComponent(e)}`;try{const e=await fetch(t,{method:"GET"});if(e.ok){const t=await e.json();if(Array.isArray(t))return t}}catch(e){console.error("Error fetching tags:",e)}return[]}async function setItemTag(e,t){const o={_csrf:document.querySelector('input[name="_csrf"]')?.getAttribute("value")||"",id_tag:t.id,name_tag:"",id_entry:e,checked:!!t.checked,ajax:1};try{const e=await fetch("./?c=tag&a=tagEntry&ajax=1",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(o)});if(e.ok){const t=await e.text();if(t&&t.trim().length>0)try{JSON.parse(t)}catch(e){console.error("Error parsing tag update response:",e)}}else console.error("Failed to update tag:",e.status)}catch(e){console.error("Error updating tag:",e)}}function collapseBackgroundFeedItem(e){const t=e;let o=t.classList.contains("active")&&t.classList.contains("current");const a=t.querySelectorAll("iframe");(a||youtubeExtensionInstalled)&&a.forEach(e=>{const t=e.getAttribute("src");t&&(e.setAttribute("data-original",t),e.setAttribute("src",""))}),o&&(t.classList.remove("active"),t.classList.remove("current"))}function getCurrentPage(){const e=window.location.pathname,t=new URLSearchParams(window.location.search);function o(e){return e.split(" ").map(e=>"yl-page-"+e).join(" ")}const a=[{path:"/i/",match:()=>!(t.has("a")&&"normal"!==t.get("a")||t.has("get")||t.has("c")),className:"home"},{path:"/i/",match:()=>"extension"===t.get("c"),className:"extension"},{path:"/i/",match:()=>"normal"===t.get("a")&&"i"===t.get("get"),className:"important"},{path:"/i/",match:()=>"normal"===t.get("a")&&"s"===t.get("get"),className:"watch_later"},{path:"/i/",match:()=>"normal"===t.get("a")&&"T"===t.get("get"),className:"playlists"},{path:"/i/",match:()=>"normal"===t.get("a")&&/^t_\d+$/.test(t.get("get")||""),className:()=>`playlists t_${(t.get("get")||"").substring(2)}`},{path:"/i/",match:()=>"normal"===t.get("a")&&t.get("get")&&t.get("get").startsWith("c_"),className:()=>`category c_${t.get("get").substring(2)}`}];for(const t of a)if(e===t.path&&t.match()){return o("function"==typeof t.className?t.className():t.className)}return""}function getCategoryWhitelist(){const e=document.querySelector("#yl_category_whitelist");if(!e)return[];const t=e.getAttribute("data-yl-category-whitelist");if(!t)return["all"];const o=t.split(",").map(e=>e.trim()).filter(Boolean);try{localStorage.setItem("youlagCategoryWhitelist",JSON.stringify(o))}catch(e){}return o}function isPageWhitelisted(e,t){if(e.includes("all"))return!0;if(t.startsWith("yl-page-category")){const o=t.match(/c_(\d+)/);return!!o&&e.includes("c_"+o[1])}const o=new URLSearchParams(window.location.search).get("get"),a=[{regex:/^f_\d+$/,selector:"#sidebar .tree-folder.category.active",idPrefix:"c_"},{regex:/^t_\d+$/,selector:"#sidebar .tree-folder.category.tags.active",idPrefix:"t_"}];for(const{regex:t,selector:n,idPrefix:i}of a)if(t.test(o||"")){const t=document.querySelector(n);if(t){let o=t.getAttribute("id");if(o="tags"===o?"playlists":o,o&&e.includes(o))return!0}return!1}return["home","important","watch_later","playlists"].some(o=>e.includes(o)&&t===`yl-page-${o}`)}function setCategoryWhitelistClass(){let e=[];try{const t=localStorage.getItem("youlagCategoryWhitelist");t&&(e=JSON.parse(t))}catch(e){}const t=getCurrentPage(),o=isPageWhitelisted(e,t);youlagActive=o,document.body.classList.toggle("youlag-active",o),document.body.classList.toggle("youlag-inactive",!o);const a=getCategoryWhitelist(),n=isPageWhitelisted(a,t);if(youlagActive=n,n!==o){document.body.classList.toggle("youlag-active",n),document.body.classList.toggle("youlag-inactive",!n);try{localStorage.setItem("youlagCategoryWhitelist",JSON.stringify(a))}catch(e){}return n}return o}function setVideoLabelsClass(){const e=localStorage.getItem("youlagVideoLabels")||!1,t=document.querySelector("#yl_video_labels");let o;t&&(o=t.getAttribute("data-yl-video-labels"),console.log("Youlag Video Labels - user setting from DOM:",o)),"true"===o?(document.body.classList.add("youlag-video-labels"),localStorage.setItem("youlagVideoLabels","true")):"false"===o?(document.body.classList.remove("youlag-video-labels"),localStorage.setItem("youlagVideoLabels","false")):"true"===e?document.body.classList.add("youlag-video-labels"):document.body.classList.remove("youlag-video-labels")}function setBodyPageClass(){getCurrentPage()&&(document.body.className+=" "+getCurrentPage()),setVideoLabelsClass(),setCategoryWhitelistClass()}function init(){setBodyPageClass(),setupClickListener(),setupTagsDropdownOverride(),setTimeout(()=>{youlagSettingsPageEventListeners()},1500),restoreVideoQueue(),removeYoulagLoadingState(),youlagScriptLoaded=!0}function removeYoulagLoadingState(){document.body.classList.add("youlag-loaded")}function initFallback(){"complete"===document.readyState||"interactive"===document.readyState||!0===youlagScriptLoaded?init():(document.addEventListener("DOMContentLoaded",init),window.addEventListener("load",init))}const checkInitInterval=setInterval(()=>{"complete"!==document.readyState&&!0!==youlagScriptLoaded||(init(),clearInterval(checkInitInterval))},1e3);initFallback();