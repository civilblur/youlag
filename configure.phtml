<?php
declare(strict_types=1);
/** @var YoulagExtension $this */
?>

<div class="yl-extension-settings-container" id="yl-settings-root">

  <form class="yl-extension-settings-form" action="<?php echo _url('extension', 'configure', 'e', urlencode($this->getName())); ?>" method="post" data-auto-leave-validation="1">
    <input type="hidden" name="_csrf" value="<?php echo FreshRSS_Auth::csrfToken(); ?>" />

    <h2>Youlag settings</h2>

    <section class="yl-form-section">
      <?php
      $categories = isset($_SESSION['ext_categories']) ? $_SESSION['ext_categories'] : array();
      ?>

      <h3>Appearance & behavior</h3>

      <h4 class="mb-0">
        Video mode
        <div class="yl-form-group-help">
          Select the pages and categories whose feeds will be displayed in Youlag's video interface.
        </div>
      </h4>
      <?php if (!empty($categories)): ?>
        <div class="yl-form-category-container">
          <?php $whitelist = $this->getCategoryWhitelist(); ?>
          <!-- Place checkbox outside of label to utilize the checked="checked" state for visual statemanagement via css. -->
          <input id="yl_category_all" type="checkbox" name="yl_category_whitelist[]" value="all"
            <?php echo ((empty($whitelist) || in_array('all', $whitelist)) && !in_array('none', $whitelist)) ? ' checked="checked"' : ''; ?>>
          <label for="yl_category_all" class="inline-block">
            All pages and categories
          </label>
          <div class="yl-form-category-subitem-container">
            <hr>
            <label>
              <input type="checkbox" name="yl_category_whitelist[]" value="home"
                 <?php echo in_array('home', $whitelist) ? ' checked="checked"' : ''; ?>>
              Subscriptions
            </label>
            <label>
              <input type="checkbox" name="yl_category_whitelist[]" value="important"
                 <?php echo in_array('important', $whitelist) ? ' checked="checked"' : ''; ?>>
              Important
            </label>
            <label>
              <input type="checkbox" name="yl_category_whitelist[]" value="watch_later"
                 <?php echo in_array('watch_later', $whitelist) ? ' checked="checked"' : ''; ?>>
                <span class="yl-form-category__original-label">Favorites</span>
                <span class="yl-form-category__video-label">Watch later</span>
            </label>
            <label>
              <input type="checkbox" name="yl_category_whitelist[]" value="playlists"
                 <?php echo in_array('playlists', $whitelist) ? ' checked="checked"' : ''; ?>>
                <span class="yl-form-category__original-label">My Labels</span>
                <span class="yl-form-category__video-label">Playlists</span>
            </label>
            <label>
              <input type="checkbox" name="yl_category_whitelist[]" value="search_results"
                 <?php echo in_array('search_results', $whitelist) ? ' checked="checked"' : ''; ?>>
              Search results
            </label>
            <label>
            <?php foreach ($categories as $cat): ?>
              <?php $catId = (string)$cat->id(); ?>
              <label>
                <input
                  type="checkbox"
                  name="yl_category_whitelist[]"
                  value="<?php echo 'c_' . htmlspecialchars($catId); ?>"
                    <?php echo in_array('c_' . $catId, $whitelist) ? ' checked="checked"' : ''; ?>>
                <?php echo htmlspecialchars((string)$cat->name()); ?>
              </label>
            <?php endforeach; ?>
          </div>
        </div>
      <?php else: ?>
        <div class="yl-form-group-help">No categories found.</div>
      <?php endif; ?>

      <h4 class="mb-0">
        Mini player
      </h4>
      <label for="yl_mini_player_swipe_enabled" class="flex">
          <input type="checkbox" id="yl_mini_player_swipe_enabled" name="yl_mini_player_swipe_enabled" value="1" class="mb-auto"
            <?php echo ($this->yl_mini_player_swipe_enabled) ? ' checked="checked"' : ''; ?>>
        <div class="inline-block">
          Swipe down in video mode to activate mini player
          <div class="yl-form-group-help">
            Touch devices: only swipes outside the video itself are recognized.
          </div>
        </div>
      </label>

      <h4 class="mb-0">
        Watch more suggestions

        <div class="yl-form-group-help">
          The "Watch more" section appears in the video modal and only suggests entries from your subscriptions.
        </div>
      </h4>
          <?php 
            $yl_related_videos = isset($this->yl_related_videos) ? $this->yl_related_videos : null;
          ?>
        <label for="yl_related_videos_watch_later" class="flex">
          <input type="radio" id="yl_related_videos_watch_later" name="yl_related_videos" value="watch_later" class="mb-auto"
            <?php echo ($yl_related_videos === null || $yl_related_videos === "watch_later") ? ' checked="checked"' : ''; ?>>
          <div class="inline-block">
            Random from 
            <span class="yl-form-category__original-label">Favorites</span>
            <span class="yl-form-category__video-label">Watch later</span>
          </div>
        </label>
        <label for="yl_related_videos_subscriptions" class="flex">
          <input type="radio" id="yl_related_videos_subscriptions" name="yl_related_videos" value="subscriptions" class="mb-auto"
            <?php echo ($yl_related_videos === 'subscriptions') ? ' checked="checked"' : ''; ?>>
          <div class="inline-block">
            Latest from Subscriptions
          </div>
        </label>
        <label for="yl_related_videos_author" class="flex">
          <input type="radio" id="yl_related_videos_author" name="yl_related_videos" value="author" class="mb-auto"
            <?php echo ($yl_related_videos === 'author') ? ' checked="checked"' : ''; ?>>
          <div class="inline-block">
            Latest from author
          </div>
        </label>
        <label for="yl_related_videos_disabled" class="flex">
          <input type="radio" id="yl_related_videos_disabled" name="yl_related_videos" value="none" class="mb-auto"
            <?php echo ($yl_related_videos === 'none') ? ' checked="checked"' : ''; ?>>
          <div class="inline-block">
            Disable
            <div class="yl-form-group-help">
              Escape the doom scrolling.
            </div>
          </div>
        </label>

    


      <h4 class="mb-0">
        Labels
      </h4>
      <label for="yl_video_labels_enabled" class="flex">
          <input type="checkbox" id="yl_video_labels_enabled" name="yl_video_labels_enabled" value="1" class="mb-auto"
            <?php echo ($this->yl_video_labels_enabled) ? ' checked="checked"' : ''; ?>>
        <div class="inline-block">
          Use video platform labels
          <div class="yl-form-group-help">
            Renames "Favorites → Watch later", "My Labels → Playlists".
          </div>
        </div>
      </label>
      <label for="yl_video_unread_badge_enabled" class="flex">
          <input type="checkbox" id="yl_video_unread_badge_enabled" name="yl_video_unread_badge_enabled" value="1" class="mb-auto"
            <?php echo ($this->yl_video_unread_badge_enabled) ? ' checked="checked"' : ''; ?>>
        <div class="inline-block">
          Show "New" badge for unwatched videos
          <div class="yl-form-group-help">
            Applied to entries in video mode only.
          </div>
        </div>
      </label>

      <h4 class="mb-0">
        Sorting
      </h4>
      <label for="yl_video_sort_modified_enabled" class="flex">
          <input type="checkbox" id="yl_video_sort_modified_enabled" name="yl_video_sort_modified_enabled" value="1" class="mb-auto"
            <?php echo ($this->yl_video_sort_modified_enabled) ? ' checked="checked"' : ''; ?>>
        <div class="inline-block">
          Sort 
          <span class="yl-form-category__original-label">"Favorite"</span><span class="yl-form-category__video-label">"Watch later"</span> 
          by recently modified
          <div class="yl-form-group-help">
            Entries will be sorted by the time they were added or read, rather than by received date.
          </div>
        </div>
      </label>


    </section>
    <section class="yl-form-section">
      <h3>Subscription</h3>

      <h4 class="mb-0">
        YouTube shorts
      </h4>
      <label for="yl_block_youtube_shorts" class="flex">
          <input type="checkbox" id="yl_block_youtube_shorts" name="yl_block_youtube_shorts" value="1" class="mb-auto"
            <?php echo ($this->yl_block_youtube_shorts_enabled) ? ' checked="checked"' : ''; ?>>
        <div class="inline-block">
          Block incoming YouTube shorts
          <div class="yl-form-group-help">
            Existing shorts in feeds will not be affected.
          </div>
        </div>
      </label>
    </section>
    <section class="yl-form-section">

      <h3>Default video playback source</h3>

      <div class="form-group">

        <div class="group-controls">

          <div class="yl-form-group--radio">
            <div class="form-group">
              <div class="yl-form-group--radio-input-container">
                <label for="yl_playback_youtube">YouTube</label>
                <div class="yl-form-control-radio-input">
                  <input type="radio" id="yl_playback_youtube" name="yl_invidious_enabled" value="0" 
                    <?= !$this->isInvidiousEnabled() ? 'checked="checked"' : '' ?>
                  >
                  <div class="group-controls">
                    <input type="text" value="https://youtube.com" readonly>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="yl-form-group--radio">
            <div class="form-group">
              <div class="yl-form-group--radio-input-container">
                <label for="yl_playback_invidious">Invidious</label>
                <div class="yl-form-group-help">The base URL of the Invidious instance.</div>
                <div class="yl-form-control-radio-input">
                  <input type="radio" id="yl_playback_invidious" name="yl_invidious_enabled" value="1" 
                    <?= $this->isInvidiousEnabled() ? 'checked="checked"' : '' ?>
                  >
                  <div class="group-controls">
                    <input type="text" id="yl_invidious_url_1" name="yl_invidious_url_1" placeholder="https://" value="<?php echo FreshRSS_Context::$user_conf->yl_invidious_url_1; ?>">
                  </div>
                </div>
              </div>
            </div>
            
          </div>

        </div>
      </div>

    </section>

    <div class="form-group form-actions">
      <div class="group-controls">
        <button type="submit" class="btn btn-important">Submit</button>
        <button type="reset"  class="btn">Cancel</button>

        <a id="yl_check_updates" href="https://github.com/civilblur/youlag/releases" target="_blank" rel="noopener noreferrer" class="btn">Check for updates (Github)</a>
      </div>
    </div>
  </form>

</div>
